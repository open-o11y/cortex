<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.72.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Cortex Architecture | Cortex</title><meta property="og:title" content="Cortex Architecture"><meta property="og:description" content="Cortex consists of multiple horizontally scalable microservices. Each microservice uses the most appropriate technique for horizontal scaling; most are stateless and can handle requests for any users while some (namely the ingesters) are semi-stateful and depend on consistent hashing. This document provides a basic overview of Cortex&rsquo;s architecture.
The role of Prometheus Prometheus instances scrape samples from various targets and then push them to Cortex (using Prometheus&rsquo; remote write API). That remote write API emits batched Snappy-compressed Protocol Buffer messages inside the body of an HTTP PUT request."><meta property="og:type" content="article"><meta property="og:url" content="/docs/architecture/"><meta property="og:image" content="/images/logo-twitter-card.jpg"><meta property="og:site_name" content="Cortex"><meta itemprop=name content="Cortex Architecture"><meta itemprop=description content="Cortex consists of multiple horizontally scalable microservices. Each microservice uses the most appropriate technique for horizontal scaling; most are stateless and can handle requests for any users while some (namely the ingesters) are semi-stateful and depend on consistent hashing. This document provides a basic overview of Cortex&rsquo;s architecture.
The role of Prometheus Prometheus instances scrape samples from various targets and then push them to Cortex (using Prometheus&rsquo; remote write API). That remote write API emits batched Snappy-compressed Protocol Buffer messages inside the body of an HTTP PUT request."><meta itemprop=wordCount content="2800"><meta itemprop=image content="/images/logo-twitter-card.jpg"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/images/logo-twitter-card.jpg"><meta name=twitter:title content="Cortex Architecture"><meta name=twitter:description content="Cortex consists of multiple horizontally scalable microservices. Each microservice uses the most appropriate technique for horizontal scaling; most are stateless and can handle requests for any users while some (namely the ingesters) are semi-stateful and depend on consistent hashing. This document provides a basic overview of Cortex&rsquo;s architecture.
The role of Prometheus Prometheus instances scrape samples from various targets and then push them to Cortex (using Prometheus&rsquo; remote write API). That remote write API emits batched Snappy-compressed Protocol Buffer messages inside the body of an HTTP PUT request."><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-63872299-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><link rel=preload href=/scss/main.min.e90eaa454320b057abaa93e650772218ea4d1e3c83e8c45ecd880c9ee9f60107.css as=style><link href=/scss/main.min.e90eaa454320b057abaa93e650772218ea4d1e3c83e8c45ecd880c9ee9f60107.css rel=stylesheet integrity><link href=/css/offline-search.css rel=stylesheet><script src=https://code.jquery.com/jquery-3.3.1.min.js integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.1.6/lunr.js></script><script src=/js/offline-search.js></script><title>Cortex Architecture | Cortex</title></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar navbar-nocover"><a id=cortex-logo class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" role="img" viewBox="-17.92 -14.92 1191.84 462.84"><defs><style>.cls-1{fill:#fff}</style></defs><path d="M214.531 8.017C99.353 8.017 5.65 101.72 5.65 216.899S99.353 425.78 214.531 425.78s208.882-93.704 208.882-208.882S329.71 8.017 214.531 8.017zm0 408.558c-110.102.0-199.676-89.574-199.676-199.676S104.429 17.222 214.53 17.222 414.208 106.797 414.208 216.9 324.633 416.575 214.53 416.575z" class="cls-1"/><circle cx="327.452" cy="221.633" r="34.571" class="cls-1"/><circle cx="213.713" cy="353.584" r="34.571" class="cls-1"/><path d="M299.992 167.913l-59-56.05a34.578 34.578.0 10-4.343 4.34l57.828 54.937a60.158 60.158.0 00-27.168 49.123h-12.97l-23.456-67.02-26.055 64.718H175.73l-24.724 57.22-21.808-54.524-.063.025v-.586h-22.048a34.582 34.582.0 10-.275 6.138h18.005l25.97 64.925 28.977-67.06h29.207l21.51-53.424 19.503 55.725H267.5a60.173 60.173.0 0025.202 44.11l-56.52 56.52 4.34 4.338 57.492-57.492a60.155 60.155.0 101.977-105.963zm81.481 53.515a54.02 54.02.0 11-54.022-54.02 54.083 54.083.0 0154.022 54.02zm175.707 42.568q-8.797 8.178-24.405 8.177a34.858 34.858.0 01-17.095-3.965 33.188 33.188.0 01-11.643-10.529 46.374 46.374.0 01-6.566-14.99 71.134 71.134.0 01-2.105-17.341 86.99 86.99.0 011.982-18.706 46.804 46.804.0 016.565-15.98 34.028 34.028.0 0112.263-11.149 7.675-4.21 19.077-4.212 13.38.0 21.306 6.69 7.927 6.689 10.405 18.829h21.803a50.76 50.76.0 00-5.946-19.696 44.06 44.06.0 00-12.015-13.75 49.842 49.842.0 00-16.848-8.051 77.44 77.44.0 00-20.44-2.601q-15.114.0-26.509 5.326a52.935 52.935.0 00-18.952 14.617 62.165 62.165.0 00-11.273 21.8 94.013 94.013.0 00-3.717 26.883 86.195 86.195.0 003.84 26.386 57.783 57.783.0 0011.397 20.686 50.138 50.138.0 0018.829 13.38 66.766 66.766.0 0025.891 4.705 24.527.0 38.772-12.882 14.245-12.878 17.715-36.668h-21.556q-1.986 14.867-10.776 23.041zm157.44-87.828a56.338 56.338.0 00-19.447-14.244q-11.52-5.203-26.882-5.203-15.115.0-26.756 5.203a56.009 56.009.0 00-19.573 14.244 59.75 59.75.0 00-11.892 21.307 85.299 85.299.0 00-3.965 26.386 84.117 84.117.0 003.965 26.262 59.853 59.853.0 0011.892 21.183 54.61 54.61.0 0019.573 14.12 11.643 5.077 26.756 5.08 15.36.0 26.882-5.08a54.908 54.908.0 0019.447-14.12 59.95 59.95.0 0011.892-21.183 84.181 84.181.0 003.965-26.262 85.364 85.364.0 00-3.965-26.386 59.846 59.846.0 00-11.892-21.307zm-9.538 68.38a43.305 43.305.0 01-8.548 15.113 37.061 37.061.0 01-12.759 9.29 38.825 38.825.0 01-30.968.0 37.003 37.003.0 01-12.76-9.29 43.209 43.209.0 01-8.547-15.114 70.669 70.669.0 010-41.373 44.634 44.634.0 018.547-15.237 36.428 36.428.0 0112.76-9.415 38.826 38.826.0 0130.968.0 36.484 36.484.0 0112.76 9.415 44.735 44.735.0 018.547 15.237 70.624 70.624.0 010 41.373zm81.141-80.89q-11.147 7.434-18.83 23.041h-.493v-27.005h-19.82V287.78h21.057v-56.984a87.528 87.528.0 012.478-21.924 41.993 41.993.0 017.93-16.228 33.951 33.951.0 0114.368-10.158q8.919-3.468 21.555-3.468V156.72q-17.097-.493-28.245 6.937zm80.761-42.366h-21.06v38.402h-21.8v18.581h21.8v81.51a48.668 48.668.0 001.734 14.37 17.432 17.432.0 005.326 8.423 20.57 20.57.0 009.415 4.088 75.59 75.59.0 0013.999 1.115h16.104v-18.582h-9.664a70.335 70.335.0 01-8.05-.37 10.361 10.361.0 01-4.833-1.611 6.108 6.108.0 01-2.354-3.469 23.006 23.006.0 01-.617-5.946v-79.528h25.518v-18.581h-25.518zm148.522 60.452a56.135 56.135.0 00-18.085-17.962q-11.276-7.063-28.367-7.06a58.263 58.263.0 00-24.155 4.953 56.796 56.796.0 00-19.079 13.875 63.949 63.949.0 00-12.51 21.058 77.064 77.064.0 00-4.461 26.758 102.521 102.521.0 004.338 27.004 58.87 58.87.0 0011.519 21.307 52.43 52.43.0 0018.953 13.873 11.272 4.954 26.632 4.955 21.8.0 36.173-10.901 14.364-10.898 18.58-32.455h-20.81q-2.73 12.635-11.272 18.829-8.549 6.198-21.927 6.195a43.577 43.577.0 01-18.085-3.468 35.417 35.417.0 01-12.636-9.291 36.127 36.127.0 01-7.184-13.38 50.746 50.746.0 01-1.981-15.98h95.879a102.07 102.07.0 00-2.107-24.526 71.064 71.064.0 00-9.415-23.784zm-84.357 29.73a43.81 43.81.0 013.219-13.999 37.354 37.354.0 0034.013 34.013.0 111.272-7.803 000 114.74-2.85 36.062 36.062 002.85 36.492 36.492.0 111.398 0036.107.0 17.68 11.52 43.253 0013.345 14.122zm170.95 7.184 44.1-58.964h-25.271l-31.961 44.843-30.721-44.843h-27.006l44.595 60.698-48.063 67.389h25.518l35.677-53.019 35.676 53.019h27.006l-49.55-69.123z" class="cls-1"/></svg></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a href=https://twitter.com/cortexmetrics class="nav-link active"><span class=active><i class="fab fa-fw fa-twitter"></i>Twitter</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a href=https://github.com/cortexproject class="nav-link active"><span class=active><i class="fab fa-fw fa-github"></i>Github</span></a></li></ul></div><div class="navbar-nav d-none d-md-block"><div id=search-nav-container><input type=search id=search-input autocomplete=off class="form-control td-search-input" placeholder="&#xf002 Search this siteâ€¦" autocomplete=on><div id=search-results class=container></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><nav class="collapse td-sidebar-nav pt-2 pl-4" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Documentation</a></li><ul><li class="collapse show" id=docs><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/getting-started/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Getting Started</a></li><ul><li class=collapse id=docsgetting-started><a class="td-sidebar-link td-sidebar-link__page" id=m-docsgetting-startedgetting-started-chunks-storage href=/docs/getting-started/getting-started-chunks-storage/>Chunks Storage</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsgetting-startedgetting-started-blocks-storage href=/docs/getting-started/getting-started-blocks-storage/>Blocks Storage</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsgetting-startedgetting-started-with-gossiped-ring href=/docs/getting-started/getting-started-with-gossiped-ring/>Gossip Ring</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page active" id=m-docsarchitecture href=/docs/architecture/>Architecture</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/production/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Production</a></li><ul><li class=collapse id=docsproduction><a class="td-sidebar-link td-sidebar-link__page" id=m-docsproductionrunning-in-production href=/docs/production/running-in-production/>Running Cortex in Production</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproductionaws href=/docs/production/aws/>Running Cortex with AWS Services</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproductioncassandra href=/docs/production/cassandra/>Running Cortex with Cassandra</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproductioncaching href=/docs/production/caching/>Caching in Cortex</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproductioningesters-with-wal href=/docs/production/ingesters-with-wal/>Ingesters with WAL</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproductiontls href=/docs/production/tls/>Securing communication between Cortex components with TLS</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproductionauth href=/docs/production/auth/>Authentication and Authorisation</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproductionha-pair-handling href=/docs/production/ha-pair-handling/>Config for sending HA Pairs data to Cortex</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/api/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">HTTP API</a></li><ul><li class=collapse id=docsapi></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/guides/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Guides</a></li><ul><li class=collapse id=docsguides><a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesdeleting-series href=/docs/guides/deleting-series/>Deleting Series</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesgrpc-based-plugin href=/docs/guides/grpc-based-plugin/>gRPC storage plugin</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesruler-sharding href=/docs/guides/ruler-sharding/>Config for horizontally scaling the Ruler</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesshuffle-sharding href=/docs/guides/shuffle-sharding/>Shuffle Sharding</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguideszone-aware-replication href=/docs/guides/zone-aware-replication/>Zone Aware Replication</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguideskubernetes href=/docs/guides/kubernetes/>Running Cortex on Kubernetes</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidestracing href=/docs/guides/tracing/>Tracing</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesingesters-rolling-updates href=/docs/guides/ingesters-rolling-updates/>Ingesters rolling updates</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidescapacity-planning href=/docs/guides/capacity-planning/>Capacity Planning</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/configuration/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Configuration</a></li><ul><li class=collapse id=docsconfiguration><a class="td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationconfiguration-file href=/docs/configuration/configuration-file/>Configuration file</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationarguments href=/docs/configuration/arguments/>Cortex Arguments Explained</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationprometheus-frontend href=/docs/configuration/prometheus-frontend/>Prometheus Frontend</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationschema-configuration href=/docs/configuration/schema-configuration/>Schema Configuration</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationsingle-process-config href=/docs/configuration/single-process-config/>Single-process</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationv1guarantees href=/docs/configuration/v1guarantees/>v1.x Guarantees</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/operations/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Operations</a></li><ul><li class=collapse id=docsoperations><a class="td-sidebar-link td-sidebar-link__page" id=m-docsoperationsquery-auditor href=/docs/operations/query-auditor/>Query Auditor (tool)</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsoperationsquery-tee href=/docs/operations/query-tee/>Query Tee (service)</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsoperationsrequests-mirroring-to-secondary-cluster href=/docs/operations/requests-mirroring-to-secondary-cluster/>Requests mirroring to secondary cluster</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsoperationsscaling-query-frontend href=/docs/operations/scaling-query-frontend/>Scaling the Query Frontend</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/blocks-storage/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Blocks Storage</a></li><ul><li class=collapse id=docsblocks-storage><a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagequerier href=/docs/blocks-storage/querier/>Querier</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagestore-gateway href=/docs/blocks-storage/store-gateway/>Store-gateway</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagecompactor href=/docs/blocks-storage/compactor/>Compactor</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storageproduction-tips href=/docs/blocks-storage/production-tips/>Production tips</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagebinary-index-header href=/docs/blocks-storage/binary-index-header/>Binary index-header</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagemigrate-cortex-cluster-from-chunks-to-blocks href=/docs/blocks-storage/migrate-cortex-cluster-from-chunks-to-blocks/>Migrate Cortex cluster from chunks to blocks</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storageconvert-long-term-storage-from-chunks-to-blocks href=/docs/blocks-storage/convert-long-term-storage-from-chunks-to-blocks/>Convert long-term storage from chunks to blocks</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagemigrate-storage-from-thanos-and-prometheus href=/docs/blocks-storage/migrate-storage-from-thanos-and-prometheus/>Migrate the storage from Thanos and Prometheus</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/contributing/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Contributing</a></li><ul><li class=collapse id=docscontributing><a class="td-sidebar-link td-sidebar-link__page" id=m-docscontributingdesign-patterns-and-code-conventions href=/docs/contributing/design-patterns-and-code-conventions/>Design patterns and Code conventions</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-to-run-the-website-locally href=/docs/contributing/how-to-run-the-website-locally/>How to run the website locally</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-to-upgrade-golang-version href=/docs/contributing/how-to-upgrade-golang-version/>How to upgrade Golang version</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-integration-tests-work href=/docs/contributing/how-integration-tests-work/>How integration tests work</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-to-update-the-build-image href=/docs/contributing/how-to-update-the-build-image/>How to update the build image</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/case-studies/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Case Studies</a></li><ul><li class=collapse id=docscase-studies><a class="td-sidebar-link td-sidebar-link__page" id=m-docscase-studiesgojek href=/docs/case-studies/gojek/>Gojek</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscase-studiesrewe-digital href=/docs/case-studies/rewe-digital/>REWE digital</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/governance/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Governance</a></li><ul><li class=collapse id=docsgovernance><a class="td-sidebar-link td-sidebar-link__page" id=m-docsgovernancehow-to-add-a-maintainer href=/docs/governance/how-to-add-a-maintainer/>How to add a maintainer</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-docschangelog href=/docs/changelog/>Changelog</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/proposals/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Proposals</a></li><ul><li class=collapse id=docsproposals><a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsblocks-storage-sharding href=/docs/proposals/blocks-storage-sharding/>Blocks storage sharding</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsdocumentation-versioning href=/docs/proposals/documentation-versioning/>Documentation Versioning</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsgeneralize-modules href=/docs/proposals/generalize-modules/>Generalize Modules Service to make it extensible</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalshttp-api-design href=/docs/proposals/http-api-design/>HTTP API Design</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsingesters-migration href=/docs/proposals/ingesters-migration/>Migrating ingesters from chunks to blocks and back.</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsscalable-query-frontend href=/docs/proposals/scalable-query-frontend/>Scalable Query Frontend</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsshuffle-sharding-and-zone-awareness href=/docs/proposals/shuffle-sharding-and-zone-awareness/>Shuffle sharding and zone awareness</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsshuffle-sharding-on-the-read-path href=/docs/proposals/shuffle-sharding-on-the-read-path/>Shuffle sharding on the read path</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalssupport-metadata-api href=/docs/proposals/support-metadata-api/>Support metadata API</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-docscode-of-conduct href=/docs/code-of-conduct/>Code of Conduct</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsroadmap href=/docs/roadmap/>Roadmap</a></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/cortexproject/cortex/edit/master/docs/architecture.md target=_blank><i class="fa fa-edit fa-fw"></i>Edit this page</a>
<a href="https://github.com/cortexproject/cortex/issues/new?title=Cortex%20Architecture" target=_blank><i class="fab fa-github fa-fw"></i>Create documentation issue</a>
<a href=https://github.com/cortexproject/cortex/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i>Create project issue</a></div><nav id=TableOfContents><ul><li><a href=#the-role-of-prometheus>The role of Prometheus</a></li><li><a href=#storage>Storage</a><ul><li><a href=#chunks-storage-default>Chunks storage (default)</a></li><li><a href=#blocks-storage>Blocks storage</a></li></ul></li><li><a href=#services>Services</a><ul><li><a href=#distributor>Distributor</a></li><li><a href=#ingester>Ingester</a></li><li><a href=#querier>Querier</a></li><li><a href=#query-frontend>Query frontend</a></li><li><a href=#ruler>Ruler</a></li><li><a href=#alertmanager>Alertmanager</a></li><li><a href=#configs-api>Configs API</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=/docs/>Documentation</a></li><li class="breadcrumb-item active" aria-current=page><a href=/docs/architecture/>Architecture</a></li></ol></nav><div class=td-content><h1>Cortex Architecture</h1><p>Cortex consists of multiple horizontally scalable microservices. Each microservice uses the most appropriate technique for horizontal scaling; most are stateless and can handle requests for any users while some (namely the <a href=#ingester>ingesters</a>) are semi-stateful and depend on consistent hashing. This document provides a basic overview of Cortex&rsquo;s architecture.</p><p align=center><img src=/images/architecture.png alt="Cortex Architecture"></p><h2 id=the-role-of-prometheus>The role of Prometheus</h2><p>Prometheus instances scrape samples from various targets and then push them to Cortex (using Prometheus&rsquo; <a href=https://prometheus.io/docs/prometheus/latest/storage/#remote-storage-integrations>remote write API</a>). That remote write API emits batched <a href=https://google.github.io/snappy/>Snappy</a>-compressed <a href=https://developers.google.com/protocol-buffers/>Protocol Buffer</a> messages inside the body of an HTTP <code>PUT</code> request.</p><p>Cortex requires that each HTTP request bear a header specifying a tenant ID for the request. Request authentication and authorization are handled by an external reverse proxy.</p><p>Incoming samples (writes from Prometheus) are handled by the <a href=#distributor>distributor</a> while incoming reads (PromQL queries) are handled by the <a href=#querier>querier</a> or optionally by the <a href=#query-frontend>query frontend</a>.</p><h2 id=storage>Storage</h2><p>Cortex currently supports two storage engines to store and query the time series:</p><ul><li>Chunks (default)</li><li>Blocks</li></ul><p>The two engines mostly share the same Cortex architecture with few differences outlined in the rest of the document.</p><h3 id=chunks-storage-default>Chunks storage (default)</h3><p>The chunks storage stores each single time series into a separate object called <em>Chunk</em>. Each Chunk contains the samples for a given period (defaults to 12 hours). Chunks are then indexed by time range and labels, in order to provide a fast lookup across many (over millions) Chunks.</p><p>For this reason, the chunks storage consists of:</p><ul><li>An index for the Chunks. This index can be backed by:<ul><li><a href=https://aws.amazon.com/dynamodb>Amazon DynamoDB</a></li><li><a href=https://cloud.google.com/bigtable>Google Bigtable</a></li><li><a href=https://cassandra.apache.org>Apache Cassandra</a></li></ul></li><li>An object store for the Chunk data itself, which can be:<ul><li><a href=https://aws.amazon.com/dynamodb>Amazon DynamoDB</a></li><li><a href=https://cloud.google.com/bigtable>Google Bigtable</a></li><li><a href=https://cassandra.apache.org>Apache Cassandra</a></li><li><a href=https://aws.amazon.com/s3>Amazon S3</a></li><li><a href=https://cloud.google.com/storage/>Google Cloud Storage</a></li><li><a href=https://azure.microsoft.com/en-us/services/storage/>Microsoft Azure Storage</a></li></ul></li></ul><p>Internally, the access to the chunks storage relies on a unified interface called &ldquo;chunks store&rdquo;. Unlike other Cortex components, the chunk store is not a separate service, but rather a library embedded in the services that need to access the long-term storage: <a href=#ingester>ingester</a>, <a href=#querier>querier</a> and <a href=#ruler>ruler</a>.</p><p>The chunk and index format are versioned, this allows Cortex operators to upgrade the cluster to take advantage of new features and improvements. This strategy enables changes in the storage format without requiring any downtime or complex procedures to rewrite the stored data. A set of schemas are used to map the version while reading and writing time series belonging to a specific period of time.</p><p>The current schema recommendation is the <strong>v9 schema</strong> for most use cases and <strong>v10 schema</strong> if you expect to have very high cardinality metrics (v11 is still experimental). For more information about the schema, please check out the <a href=/docs/configuration/schema-configuration/>Schema</a> documentation.</p><h3 id=blocks-storage>Blocks storage</h3><p>The blocks storage is based on <a href=https://prometheus.io/docs/prometheus/latest/storage/>Prometheus TSDB</a>: it stores each tenant&rsquo;s time series into their own TSDB which write out their series to a on-disk Block (defaults to 2h block range periods). Each Block is composed by few files storing the chunks and the block index.</p><p>The TSDB chunk files contain the samples for multiple series. The series inside the Chunks are then indexed by a per-block index, which indexes metric names and labels to time series in the chunk files.</p><p>The blocks storage doesn&rsquo;t require a dedicated storage backend for the index. The only requirement is an object store for the Block files, which can be:</p><ul><li><a href=https://aws.amazon.com/s3>Amazon S3</a></li><li><a href=https://cloud.google.com/storage/>Google Cloud Storage</a></li><li><a href=https://azure.microsoft.com/en-us/services/storage/>Microsoft Azure Storage</a></li><li><a href=https://thanos.io/storage.md/#filesystem>Local Filesystem</a> (single node only)</li><li><a href=https://wiki.openstack.org/wiki/Swift>OpenStack Swift</a> (experimental)</li></ul><p>For more information, please check out the <a href=./blocks-storage/>Blocks storage</a> documentation.</p><h2 id=services>Services</h2><p>Cortex has a service-based architecture, in which the overall system is split up into a variety of components that perform a specific task. These components run separately and in parallel. Cortex can alternatively run in a single process mode, where all components are executed within a single process. The single process mode is particularly handy for local testing and development.</p><p>Cortex is, for the most part, a shared-nothing system. Each layer of the system can run multiple instances of each component and they don&rsquo;t coordinate or communicate with each other within that layer.</p><p>The Cortex services are:</p><ul><li><a href=#distributor>Distributor</a></li><li><a href=#ingester>Ingester</a></li><li><a href=#querier>Querier</a></li><li><a href=#query-frontend>Query frontend</a> (optional)</li><li><a href=#ruler>Ruler</a> (optional)</li><li><a href=#alertmanager>Alertmanager</a> (optional)</li><li><a href=#configs-api>Configs API</a> (optional)</li></ul><h3 id=distributor>Distributor</h3><p>The <strong>distributor</strong> service is responsible for handling incoming samples from Prometheus. It&rsquo;s the first stop in the write path for series samples. Once the distributor receives samples from Prometheus, each sample is validated for correctness and to ensure that it is within the configured tenant limits, falling back to default ones in case limits have not been overridden for the specific tenant. Valid samples are then split into batches and sent to multiple <a href=#ingester>ingesters</a> in parallel.</p><p>The validation done by the distributor includes:</p><ul><li>The metric labels name are formally correct</li><li>The configured max number of labels per metric is respected</li><li>The configured max length of a label name and value is respected</li><li>The timestamp is not older/newer than the configured min/max time range</li></ul><p>Distributors are <strong>stateless</strong> and can be scaled up and down as needed.</p><h4 id=high-availability-tracker>High Availability Tracker</h4><p>The distributor features a <strong>High Availability (HA) Tracker</strong>. When enabled, the distributor deduplicates incoming samples from redundant Prometheus servers. This allows you to have multiple HA replicas of the same Prometheus servers, writing the same series to Cortex and then deduplicate these series in the Cortex distributor.</p><p>The HA Tracker deduplicates incoming samples based on a cluster and replica label. The cluster label uniquely identifies the cluster of redundant Prometheus servers for a given tenant, while the replica label uniquely identifies the replica within the Prometheus cluster. Incoming samples are considered duplicated (and thus dropped) if received by any replica which is not the current primary within a cluster.</p><p>The HA Tracker requires a key-value (KV) store to coordinate which replica is currently elected. The distributor will only accept samples from the current leader. Samples with one or no labels (of the replica and cluster) are accepted by default and never deduplicated.</p><p>The supported KV stores for the HA tracker are:</p><ul><li><a href=https://www.consul.io>Consul</a></li><li><a href=https://etcd.io>Etcd</a></li></ul><p>Note: Memberlist is not supported. Memberlist-based KV store propagates updates using gossip, which is very slow for HA purposes: result is that different distributors may see different Prometheus server as elected HA replica, which is definitely not desirable.</p><p>For more information, please refer to <a href=/docs/production/ha-pair-handling/>config for sending HA pairs data to Cortex</a> in the documentation.</p><h4 id=hashing>Hashing</h4><p>Distributors use consistent hashing, in conjunction with a configurable replication factor, to determine which ingester instance(s) should receive a given series.</p><p>Cortex supports two hashing strategies:</p><ol><li>Hash the metric name and tenant ID (default)</li><li>Hash the metric name, labels and tenant ID (enabled with <code>-distributor.shard-by-all-labels=true</code>)</li></ol><p>The trade-off associated with the latter is that writes are more balanced across ingesters but each query needs to talk to any ingester since a metric could be spread across multiple ingesters given different label sets.</p><h4 id=the-hash-ring>The hash ring</h4><p>A hash ring (stored in a key-value store) is used to achieve consistent hashing for the series sharding and replication across the ingesters. All <a href=#ingester>ingesters</a> register themselves into the hash ring with a set of tokens they own; each token is a random unsigned 32-bit number. Each incoming series is <a href=#hashing>hashed</a> in the distributor and then pushed to the ingester owning the tokens range for the series hash number plus N-1 subsequent ingesters in the ring, where N is the replication factor.</p><p>To do the hash lookup, distributors find the smallest appropriate token whose value is larger than the <a href=#hashing>hash of the series</a>. When the replication factor is larger than 1, the next subsequent tokens (clockwise in the ring) that belong to different ingesters will also be included in the result.</p><p>The effect of this hash set up is that each token that an ingester owns is responsible for a range of hashes. If there are three tokens with values 0, 25, and 50, then a hash of 3 would be given to the ingester that owns the token 25; the ingester owning token 25 is responsible for the hash range of 1-25.</p><p>The supported KV stores for the hash ring are:</p><ul><li><a href=https://www.consul.io>Consul</a></li><li><a href=https://etcd.io>Etcd</a></li><li>Gossip <a href=https://github.com/hashicorp/memberlist>memberlist</a></li></ul><h4 id=quorum-consistency>Quorum consistency</h4><p>Since all distributors share access to the same hash ring, write requests can be sent to any distributor and you can setup a stateless load balancer in front of it.</p><p>To ensure consistent query results, Cortex uses <a href=https://www.allthingsdistributed.com/files/amazon-dynamo-sosp2007.pdf>Dynamo-style</a> quorum consistency on reads and writes. This means that the distributor will wait for a positive response of at least one half plus one of the ingesters to send the sample to before successfully responding to the Prometheus write request.</p><h4 id=load-balancing-across-distributors>Load balancing across distributors</h4><p>We recommend randomly load balancing write requests across distributor instances. For example, if you&rsquo;re running Cortex in a Kubernetes cluster, you could run the distributors as a Kubernetes <a href=https://kubernetes.io/docs/concepts/services-networking/service/>Service</a>.</p><h3 id=ingester>Ingester</h3><p>The <strong>ingester</strong> service is responsible for writing incoming series to a <a href=#storage>long-term storage backend</a> on the write path and returning in-memory series samples for queries on the read path.</p><p>Incoming series are not immediately written to the storage but kept in memory and periodically flushed to the storage (by default, 12 hours for the chunks storage and 2 hours for the blocks storage). For this reason, the <a href=#querier>queriers</a> may need to fetch samples both from ingesters and long-term storage while executing a query on the read path.</p><p>Ingesters contain a <strong>lifecycler</strong> which manages the lifecycle of an ingester and stores the <strong>ingester state</strong> in the <a href=#the-hash-ring>hash ring</a>. Each ingester could be in one of the following states:</p><ul><li><strong><code>PENDING</code></strong><br>The ingester has just started. While in this state, the ingester doesn&rsquo;t receive neither write and read requests, and could be waiting for time series data transfer from another ingester if running the chunks storage and the <a href=/docs/guides/ingesters-rolling-updates/#chunks-storage-with-wal-disabled-hand-over>hand-over</a> is enabled.</li><li><strong><code>JOINING</code></strong><br>The ingester is starting up and joining the ring. While in this state the ingester doesn&rsquo;t receive neither write and read requests. The ingester will join the ring using tokens received by a leaving ingester as part of the <a href=/docs/guides/ingesters-rolling-updates/#chunks-storage-with-wal-disabled-hand-over>hand-over</a> process (if enabled), otherwise it could load tokens from disk (if <code>-ingester.tokens-file-path</code> is configured) or generate a set of new random ones. Finally, the ingester optionally observes the ring for tokens conflicts and then, once any conflict is resolved, will move to <code>ACTIVE</code> state.</li><li><strong><code>ACTIVE</code></strong><br>The ingester is up and running. While in this state the ingester can receive both write and read requests.</li><li><strong><code>LEAVING</code></strong><br>The ingester is shutting down and leaving the ring. While in this state the ingester doesn&rsquo;t receive write requests, while it could receive read requests.</li><li><strong><code>UNHEALTHY</code></strong><br>The ingester has failed to heartbeat to the ring&rsquo;s KV Store. While in this state, distributors skip the ingester while building the replication set for incoming series and the ingester does not receive write or read requests.</li></ul><p><em>The ingester states are interally used for different purposes, including the series hand-over process supported by the chunks storage. For more information about it, please check out the <a href=/docs/guides/ingesters-rolling-updates/#chunks-storage-with-wal-disabled-hand-over>Ingester hand-over</a> documentation.</em></p><p>Ingesters are <strong>semi-stateful</strong>.</p><h4 id=ingesters-failure-and-data-loss>Ingesters failure and data loss</h4><p>If an ingester process crashes or exits abruptly, all the in-memory series that have not yet been flushed to the long-term storage will be lost. There are two main ways to mitigate this failure mode:</p><ol><li>Replication</li><li>Write-ahead log (WAL)</li></ol><p>The <strong>replication</strong> is used to hold multiple (typically 3) replicas of each time series in the ingesters. If the Cortex cluster looses an ingester, the in-memory series hold by the lost ingester are also replicated at least to another ingester. In the event of a single ingester failure, no time series samples will be lost while, in the event of multiple ingesters failure, time series may be potentially lost if failure affects all the ingesters holding the replicas of a specific time series.</p><p>The <strong>write-ahead log</strong> (WAL) is used to write to a persistent disk all incoming series samples until they&rsquo;re flushed to the long-term storage. In the event of an ingester failure, a subsequent process restart will replay the WAL and recover the in-memory series samples.</p><p>Contrary to the sole replication and given the persistent disk data is not lost, in the event of multiple ingesters failure each ingester will recover the in-memory series samples from WAL upon subsequent restart. The replication is still recommended in order to ensure no temporary failures on the read path in the event of a single ingester failure.</p><p>The WAL for the chunks storage is disabled by default, while it&rsquo;s always enabled for the blocks storage.</p><h4 id=ingesters-write-de-amplification>Ingesters write de-amplification</h4><p>Ingesters store recently received samples in-memory in order to perform write de-amplification. If the ingesters would immediately write received samples to the long-term storage, the system would be very difficult to scale due to the very high pressure on the storage. For this reason, the ingesters batch and compress samples in-memory and periodically flush them out to the storage.</p><p>Write de-amplification is the main source of Cortex&rsquo;s low total cost of ownership (TCO).</p><h3 id=querier>Querier</h3><p>The <strong>querier</strong> service handles queries using the <a href=https://prometheus.io/docs/prometheus/latest/querying/basics/>PromQL</a> query language.</p><p>Queriers fetch series samples both from the ingesters and long-term storage: the ingesters hold the in-memory series which have not yet been flushed to the long-term storage. Because of the replication factor, it is possible that the querier may receive duplicated samples; to resolve this, for a given time series the querier internally <strong>deduplicates</strong> samples with the same exact timestamp.</p><p>Queriers are <strong>stateless</strong> and can be scaled up and down as needed.</p><h3 id=query-frontend>Query frontend</h3><p>The <strong>query frontend</strong> is an <strong>optional service</strong> providing the querier&rsquo;s API endpoints and can be used to accelerate the read path. When the query frontend is in place, incoming query requests should be directed to the query frontend instead of the queriers. The querier service will be still required within the cluster, in order to execute the actual queries.</p><p>The query frontend internally performs some query adjustments and holds queries in an internal queue. In this setup, queriers act as workers which pull jobs from the queue, execute them, and return them to the query-frontend for aggregation. Queriers need to be configured with the query frontend address (via the <code>-querier.frontend-address</code> CLI flag) in order to allow them to connect to the query frontends.</p><p>Query frontends are <strong>stateless</strong>. However, due to how the internal queue works, it&rsquo;s recommended to run a few query frontend replicas to reap the benefit of fair scheduling. Two replicas should suffice in most cases.</p><h4 id=queueing>Queueing</h4><p>The query frontend queuing mechanism is used to:</p><ul><li>Ensure that large queries, that could cause an out-of-memory (OOM) error in the querier, will be retried on failure. This allows administrators to under-provision memory for queries, or optimistically run more small queries in parallel, which helps to reduce the TCO.</li><li>Prevent multiple large requests from being convoyed on a single querier by distributing them across all queriers using a first-in/first-out queue (FIFO).</li><li>Prevent a single tenant from denial-of-service-ing (DOSing) other tenants by fairly scheduling queries between tenants.</li></ul><h4 id=splitting>Splitting</h4><p>The query frontend splits multi-day queries into multiple single-day queries, executing these queries in parallel on downstream queriers and stitching the results back together again. This prevents large (multi-day) queries from causing out of memory issues in a single querier and helps to execute them faster.</p><h4 id=caching>Caching</h4><p>The query frontend supports caching query results and reuses them on subsequent queries. If the cached results are incomplete, the query frontend calculates the required subqueries and executes them in parallel on downstream queriers. The query frontend can optionally align queries with their step parameter to improve the cacheability of the query results. The result cache is compatible with any cortex caching backend (currently memcached, redis, and an in-memory cache).</p><h3 id=ruler>Ruler</h3><p>The <strong>ruler</strong> is an <strong>optional service</strong> executing PromQL queries for recording rules and alerts. The ruler requires a database storing the recording rules and alerts for each tenant.</p><p>Ruler is <strong>semi-stateful</strong> and can be scaled horizontally.
Running rules internally have state, as well as the ring the rulers initiate.
However, if the rulers all fail and restart,
Prometheus alert rules have a feature where an alert is restored and returned to a firing state
if it would have been active in its for period.
However, there would be gaps in the series generated by the recording rules.</p><h3 id=alertmanager>Alertmanager</h3><p>The <strong>alertmanager</strong> is an <strong>optional service</strong> responsible for accepting alert notifications from the <a href=#ruler>ruler</a>, deduplicating and grouping them, and routing them to the correct notification channel, such as email, PagerDuty or OpsGenie.</p><p>The Cortex alertmanager is built on top of the <a href=https://prometheus.io/docs/alerting/alertmanager/>Prometheus Alertmanager</a>, adding multi-tenancy support. Like the <a href=#ruler>ruler</a>, the alertmanager requires a database storing the per-tenant configuration.</p><p>Alertmanager is <strong>semi-stateful</strong>.
The Alertmanager persists information about silences and active alerts to its disk.
If all of the alertmanager nodes failed simultaneously there would be a loss of data.</p><h3 id=configs-api>Configs API</h3><p>The <strong>configs API</strong> is an <strong>optional service</strong> managing the configuration of Rulers and Alertmanagers.
It provides APIs to get/set/update the ruler and alertmanager configurations and store them into backend.
Current supported backend are PostgreSQL and in-memory.</p><p>Configs API is <strong>stateless</strong>.</p><div class="text-muted mt-5 pt-3 border-top"></div></div></main></div></div><footer class="row td-box td-box--dark td-box--gradient td-box--height-auto text-white p-5"><div class="col-12 col-sm-4 pb-5 pb-sm-0"><img src=/images/cortex-stacked-white.png width=75px class="img-fluid float-left"></div><div class="col-12 col-sm-4 pb-5 pb-sm-0"><h6 class=font-weight-bold>Community</h6><ul class=list-unstyled><li><a href=https://slack.cncf.io class="text-reset text-white"><i class="fab fa-fw fa-slack"></i>Slack</a></li><li><a href=https://github.com/cortexproject/cortex class="text-reset text-white"><i class="fab fa-fw fa-github"></i>GitHub</a></li><li><a href=https://twitter.com/cortexmetrics class="text-reset text-white"><i class="fab fa-fw fa-twitter"></i>Twitter</a></li></ul></div><div class="col-12 col-sm-4"><h6 class=font-weight-bold>About</h6><p>Cortex is an OSS licensed project as Apache License 2.0</p></div></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/js/main.min.29b0315468c00226fa6f4556a9cebc0ac4fe1ce1457a01b22c0a06b329877383.js integrity="sha256-KbAxVGjAAib6b0VWqc68CsT+HOFFegGyLAoGsymHc4M=" crossorigin=anonymous></script></body></html>