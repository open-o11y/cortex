<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.72.0"><meta name=ROBOTS content="INDEX, FOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Migrate Cortex cluster from chunks to blocks | Cortex</title><meta property="og:title" content="Migrate Cortex cluster from chunks to blocks"><meta property="og:description" content="This article describes how to migrate existing Cortex cluster from chunks storage to blocks storage, and highlight possible issues you may encounter in the process.
This document replaces the Cortex proposal, which was written before support for migration was in place.
Introduction This article assumes that:
 Cortex cluster is managed by Kubernetes Cortex is using chunks storage Ingesters are using WAL Cortex version 1.3.0 or later.  If your ingesters are not using WAL, the documented procedure will still apply, but the presented migration script will not work properly without changes, as it assumes that ingesters are managed via StatefulSet."><meta property="og:type" content="article"><meta property="og:url" content="/docs/blocks-storage/migrate-cortex-cluster-from-chunks-to-blocks/"><meta property="og:image" content="/images/logo-twitter-card.jpg"><meta property="og:site_name" content="Cortex"><meta itemprop=name content="Migrate Cortex cluster from chunks to blocks"><meta itemprop=description content="This article describes how to migrate existing Cortex cluster from chunks storage to blocks storage, and highlight possible issues you may encounter in the process.
This document replaces the Cortex proposal, which was written before support for migration was in place.
Introduction This article assumes that:
 Cortex cluster is managed by Kubernetes Cortex is using chunks storage Ingesters are using WAL Cortex version 1.3.0 or later.  If your ingesters are not using WAL, the documented procedure will still apply, but the presented migration script will not work properly without changes, as it assumes that ingesters are managed via StatefulSet."><meta itemprop=wordCount content="1548"><meta itemprop=image content="/images/logo-twitter-card.jpg"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/images/logo-twitter-card.jpg"><meta name=twitter:title content="Migrate Cortex cluster from chunks to blocks"><meta name=twitter:description content="This article describes how to migrate existing Cortex cluster from chunks storage to blocks storage, and highlight possible issues you may encounter in the process.
This document replaces the Cortex proposal, which was written before support for migration was in place.
Introduction This article assumes that:
 Cortex cluster is managed by Kubernetes Cortex is using chunks storage Ingesters are using WAL Cortex version 1.3.0 or later.  If your ingesters are not using WAL, the documented procedure will still apply, but the presented migration script will not work properly without changes, as it assumes that ingesters are managed via StatefulSet."><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-63872299-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><link rel=preload href=/scss/main.min.e90eaa454320b057abaa93e650772218ea4d1e3c83e8c45ecd880c9ee9f60107.css as=style><link href=/scss/main.min.e90eaa454320b057abaa93e650772218ea4d1e3c83e8c45ecd880c9ee9f60107.css rel=stylesheet integrity><link href=/css/offline-search.css rel=stylesheet><script src=https://code.jquery.com/jquery-3.3.1.min.js integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.1.6/lunr.js></script><script src=/js/offline-search.js></script><title>Migrate Cortex cluster from chunks to blocks | Cortex</title></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar navbar-nocover"><a id=cortex-logo class=navbar-brand href=/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" role="img" viewBox="-17.92 -14.92 1191.84 462.84"><defs><style>.cls-1{fill:#fff}</style></defs><path d="M214.531 8.017C99.353 8.017 5.65 101.72 5.65 216.899S99.353 425.78 214.531 425.78s208.882-93.704 208.882-208.882S329.71 8.017 214.531 8.017zm0 408.558c-110.102.0-199.676-89.574-199.676-199.676S104.429 17.222 214.53 17.222 414.208 106.797 414.208 216.9 324.633 416.575 214.53 416.575z" class="cls-1"/><circle cx="327.452" cy="221.633" r="34.571" class="cls-1"/><circle cx="213.713" cy="353.584" r="34.571" class="cls-1"/><path d="M299.992 167.913l-59-56.05a34.578 34.578.0 10-4.343 4.34l57.828 54.937a60.158 60.158.0 00-27.168 49.123h-12.97l-23.456-67.02-26.055 64.718H175.73l-24.724 57.22-21.808-54.524-.063.025v-.586h-22.048a34.582 34.582.0 10-.275 6.138h18.005l25.97 64.925 28.977-67.06h29.207l21.51-53.424 19.503 55.725H267.5a60.173 60.173.0 0025.202 44.11l-56.52 56.52 4.34 4.338 57.492-57.492a60.155 60.155.0 101.977-105.963zm81.481 53.515a54.02 54.02.0 11-54.022-54.02 54.083 54.083.0 0154.022 54.02zm175.707 42.568q-8.797 8.178-24.405 8.177a34.858 34.858.0 01-17.095-3.965 33.188 33.188.0 01-11.643-10.529 46.374 46.374.0 01-6.566-14.99 71.134 71.134.0 01-2.105-17.341 86.99 86.99.0 011.982-18.706 46.804 46.804.0 016.565-15.98 34.028 34.028.0 0112.263-11.149 7.675-4.21 19.077-4.212 13.38.0 21.306 6.69 7.927 6.689 10.405 18.829h21.803a50.76 50.76.0 00-5.946-19.696 44.06 44.06.0 00-12.015-13.75 49.842 49.842.0 00-16.848-8.051 77.44 77.44.0 00-20.44-2.601q-15.114.0-26.509 5.326a52.935 52.935.0 00-18.952 14.617 62.165 62.165.0 00-11.273 21.8 94.013 94.013.0 00-3.717 26.883 86.195 86.195.0 003.84 26.386 57.783 57.783.0 0011.397 20.686 50.138 50.138.0 0018.829 13.38 66.766 66.766.0 0025.891 4.705 24.527.0 38.772-12.882 14.245-12.878 17.715-36.668h-21.556q-1.986 14.867-10.776 23.041zm157.44-87.828a56.338 56.338.0 00-19.447-14.244q-11.52-5.203-26.882-5.203-15.115.0-26.756 5.203a56.009 56.009.0 00-19.573 14.244 59.75 59.75.0 00-11.892 21.307 85.299 85.299.0 00-3.965 26.386 84.117 84.117.0 003.965 26.262 59.853 59.853.0 0011.892 21.183 54.61 54.61.0 0019.573 14.12 11.643 5.077 26.756 5.08 15.36.0 26.882-5.08a54.908 54.908.0 0019.447-14.12 59.95 59.95.0 0011.892-21.183 84.181 84.181.0 003.965-26.262 85.364 85.364.0 00-3.965-26.386 59.846 59.846.0 00-11.892-21.307zm-9.538 68.38a43.305 43.305.0 01-8.548 15.113 37.061 37.061.0 01-12.759 9.29 38.825 38.825.0 01-30.968.0 37.003 37.003.0 01-12.76-9.29 43.209 43.209.0 01-8.547-15.114 70.669 70.669.0 010-41.373 44.634 44.634.0 018.547-15.237 36.428 36.428.0 0112.76-9.415 38.826 38.826.0 0130.968.0 36.484 36.484.0 0112.76 9.415 44.735 44.735.0 018.547 15.237 70.624 70.624.0 010 41.373zm81.141-80.89q-11.147 7.434-18.83 23.041h-.493v-27.005h-19.82V287.78h21.057v-56.984a87.528 87.528.0 012.478-21.924 41.993 41.993.0 017.93-16.228 33.951 33.951.0 0114.368-10.158q8.919-3.468 21.555-3.468V156.72q-17.097-.493-28.245 6.937zm80.761-42.366h-21.06v38.402h-21.8v18.581h21.8v81.51a48.668 48.668.0 001.734 14.37 17.432 17.432.0 005.326 8.423 20.57 20.57.0 009.415 4.088 75.59 75.59.0 0013.999 1.115h16.104v-18.582h-9.664a70.335 70.335.0 01-8.05-.37 10.361 10.361.0 01-4.833-1.611 6.108 6.108.0 01-2.354-3.469 23.006 23.006.0 01-.617-5.946v-79.528h25.518v-18.581h-25.518zm148.522 60.452a56.135 56.135.0 00-18.085-17.962q-11.276-7.063-28.367-7.06a58.263 58.263.0 00-24.155 4.953 56.796 56.796.0 00-19.079 13.875 63.949 63.949.0 00-12.51 21.058 77.064 77.064.0 00-4.461 26.758 102.521 102.521.0 004.338 27.004 58.87 58.87.0 0011.519 21.307 52.43 52.43.0 0018.953 13.873 11.272 4.954 26.632 4.955 21.8.0 36.173-10.901 14.364-10.898 18.58-32.455h-20.81q-2.73 12.635-11.272 18.829-8.549 6.198-21.927 6.195a43.577 43.577.0 01-18.085-3.468 35.417 35.417.0 01-12.636-9.291 36.127 36.127.0 01-7.184-13.38 50.746 50.746.0 01-1.981-15.98h95.879a102.07 102.07.0 00-2.107-24.526 71.064 71.064.0 00-9.415-23.784zm-84.357 29.73a43.81 43.81.0 013.219-13.999 37.354 37.354.0 0034.013 34.013.0 111.272-7.803 000 114.74-2.85 36.062 36.062 002.85 36.492 36.492.0 111.398 0036.107.0 17.68 11.52 43.253 0013.345 14.122zm170.95 7.184 44.1-58.964h-25.271l-31.961 44.843-30.721-44.843h-27.006l44.595 60.698-48.063 67.389h25.518l35.677-53.019 35.676 53.019h27.006l-49.55-69.123z" class="cls-1"/></svg></span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a href=https://twitter.com/cortexmetrics class="nav-link active"><span class=active><i class="fab fa-fw fa-twitter"></i>Twitter</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a href=https://github.com/cortexproject class="nav-link active"><span class=active><i class="fab fa-fw fa-github"></i>Github</span></a></li></ul></div><div class="navbar-nav d-none d-md-block"><div id=search-nav-container><input type=search id=search-input autocomplete=off class="form-control td-search-input" placeholder="&#xf002 Search this site…" autocomplete=on><div id=search-results class=container></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><nav class="collapse td-sidebar-nav pt-2 pl-4" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">Documentation</a></li><ul><li class="collapse show" id=docs><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/getting-started/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Getting Started</a></li><ul><li class=collapse id=docsgetting-started><a class="td-sidebar-link td-sidebar-link__page" id=m-docsgetting-startedgetting-started-chunks-storage href=/docs/getting-started/getting-started-chunks-storage/>Chunks Storage</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsgetting-startedgetting-started-blocks-storage href=/docs/getting-started/getting-started-blocks-storage/>Blocks Storage</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsgetting-startedgetting-started-with-gossiped-ring href=/docs/getting-started/getting-started-with-gossiped-ring/>Gossip Ring</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-docsarchitecture href=/docs/architecture/>Architecture</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/production/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Production</a></li><ul><li class=collapse id=docsproduction><a class="td-sidebar-link td-sidebar-link__page" id=m-docsproductionrunning-in-production href=/docs/production/running-in-production/>Running Cortex in Production</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproductionaws href=/docs/production/aws/>Running Cortex with AWS Services</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproductioncassandra href=/docs/production/cassandra/>Running Cortex with Cassandra</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproductioncaching href=/docs/production/caching/>Caching in Cortex</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproductioningesters-with-wal href=/docs/production/ingesters-with-wal/>Ingesters with WAL</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproductiontls href=/docs/production/tls/>Securing communication between Cortex components with TLS</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproductionauth href=/docs/production/auth/>Authentication and Authorisation</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproductionha-pair-handling href=/docs/production/ha-pair-handling/>Config for sending HA Pairs data to Cortex</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/api/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">HTTP API</a></li><ul><li class=collapse id=docsapi></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/guides/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Guides</a></li><ul><li class=collapse id=docsguides><a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesdeleting-series href=/docs/guides/deleting-series/>Deleting Series</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesgrpc-based-plugin href=/docs/guides/grpc-based-plugin/>gRPC storage plugin</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesruler-sharding href=/docs/guides/ruler-sharding/>Config for horizontally scaling the Ruler</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesshuffle-sharding href=/docs/guides/shuffle-sharding/>Shuffle Sharding</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguideszone-aware-replication href=/docs/guides/zone-aware-replication/>Zone Aware Replication</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguideskubernetes href=/docs/guides/kubernetes/>Running Cortex on Kubernetes</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidestracing href=/docs/guides/tracing/>Tracing</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidesingesters-rolling-updates href=/docs/guides/ingesters-rolling-updates/>Ingesters rolling updates</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsguidescapacity-planning href=/docs/guides/capacity-planning/>Capacity Planning</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/configuration/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Configuration</a></li><ul><li class=collapse id=docsconfiguration><a class="td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationconfiguration-file href=/docs/configuration/configuration-file/>Configuration file</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationarguments href=/docs/configuration/arguments/>Cortex Arguments Explained</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationprometheus-frontend href=/docs/configuration/prometheus-frontend/>Prometheus Frontend</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationschema-configuration href=/docs/configuration/schema-configuration/>Schema Configuration</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationsingle-process-config href=/docs/configuration/single-process-config/>Single-process</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsconfigurationv1guarantees href=/docs/configuration/v1guarantees/>v1.x Guarantees</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/operations/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Operations</a></li><ul><li class=collapse id=docsoperations><a class="td-sidebar-link td-sidebar-link__page" id=m-docsoperationsquery-auditor href=/docs/operations/query-auditor/>Query Auditor (tool)</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsoperationsquery-tee href=/docs/operations/query-tee/>Query Tee (service)</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsoperationsrequests-mirroring-to-secondary-cluster href=/docs/operations/requests-mirroring-to-secondary-cluster/>Requests mirroring to secondary cluster</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsoperationsscaling-query-frontend href=/docs/operations/scaling-query-frontend/>Scaling the Query Frontend</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/blocks-storage/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Blocks Storage</a></li><ul><li class="collapse show" id=docsblocks-storage><a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagequerier href=/docs/blocks-storage/querier/>Querier</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagestore-gateway href=/docs/blocks-storage/store-gateway/>Store-gateway</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagecompactor href=/docs/blocks-storage/compactor/>Compactor</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storageproduction-tips href=/docs/blocks-storage/production-tips/>Production tips</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagebinary-index-header href=/docs/blocks-storage/binary-index-header/>Binary index-header</a>
<a class="td-sidebar-link td-sidebar-link__page active" id=m-docsblocks-storagemigrate-cortex-cluster-from-chunks-to-blocks href=/docs/blocks-storage/migrate-cortex-cluster-from-chunks-to-blocks/>Migrate Cortex cluster from chunks to blocks</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storageconvert-long-term-storage-from-chunks-to-blocks href=/docs/blocks-storage/convert-long-term-storage-from-chunks-to-blocks/>Convert long-term storage from chunks to blocks</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsblocks-storagemigrate-storage-from-thanos-and-prometheus href=/docs/blocks-storage/migrate-storage-from-thanos-and-prometheus/>Migrate the storage from Thanos and Prometheus</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/contributing/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Contributing</a></li><ul><li class=collapse id=docscontributing><a class="td-sidebar-link td-sidebar-link__page" id=m-docscontributingdesign-patterns-and-code-conventions href=/docs/contributing/design-patterns-and-code-conventions/>Design patterns and Code conventions</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-to-run-the-website-locally href=/docs/contributing/how-to-run-the-website-locally/>How to run the website locally</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-to-upgrade-golang-version href=/docs/contributing/how-to-upgrade-golang-version/>How to upgrade Golang version</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-integration-tests-work href=/docs/contributing/how-integration-tests-work/>How integration tests work</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscontributinghow-to-update-the-build-image href=/docs/contributing/how-to-update-the-build-image/>How to update the build image</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/case-studies/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Case Studies</a></li><ul><li class=collapse id=docscase-studies><a class="td-sidebar-link td-sidebar-link__page" id=m-docscase-studiesgojek href=/docs/case-studies/gojek/>Gojek</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docscase-studiesrewe-digital href=/docs/case-studies/rewe-digital/>REWE digital</a></li></ul></ul><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/governance/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Governance</a></li><ul><li class=collapse id=docsgovernance><a class="td-sidebar-link td-sidebar-link__page" id=m-docsgovernancehow-to-add-a-maintainer href=/docs/governance/how-to-add-a-maintainer/>How to add a maintainer</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-docschangelog href=/docs/changelog/>Changelog</a><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/docs/proposals/ class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Proposals</a></li><ul><li class=collapse id=docsproposals><a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsblocks-storage-sharding href=/docs/proposals/blocks-storage-sharding/>Blocks storage sharding</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsdocumentation-versioning href=/docs/proposals/documentation-versioning/>Documentation Versioning</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsgeneralize-modules href=/docs/proposals/generalize-modules/>Generalize Modules Service to make it extensible</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalshttp-api-design href=/docs/proposals/http-api-design/>HTTP API Design</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsingesters-migration href=/docs/proposals/ingesters-migration/>Migrating ingesters from chunks to blocks and back.</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsscalable-query-frontend href=/docs/proposals/scalable-query-frontend/>Scalable Query Frontend</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsshuffle-sharding-and-zone-awareness href=/docs/proposals/shuffle-sharding-and-zone-awareness/>Shuffle sharding and zone awareness</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalsshuffle-sharding-on-the-read-path href=/docs/proposals/shuffle-sharding-on-the-read-path/>Shuffle sharding on the read path</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsproposalssupport-metadata-api href=/docs/proposals/support-metadata-api/>Support metadata API</a></li></ul></ul><a class="td-sidebar-link td-sidebar-link__page" id=m-docscode-of-conduct href=/docs/code-of-conduct/>Code of Conduct</a>
<a class="td-sidebar-link td-sidebar-link__page" id=m-docsroadmap href=/docs/roadmap/>Roadmap</a></li></ul></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/cortexproject/cortex/edit/master/docs/blocks-storage/migrate-from-chunks-to-blocks.md target=_blank><i class="fa fa-edit fa-fw"></i>Edit this page</a>
<a href="https://github.com/cortexproject/cortex/issues/new?title=Migrate%20Cortex%20cluster%20from%20chunks%20to%20blocks" target=_blank><i class="fab fa-github fa-fw"></i>Create documentation issue</a>
<a href=https://github.com/cortexproject/cortex/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i>Create project issue</a></div><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#step-1-preparation>Step 1: Preparation</a><ul><li><a href=#querier-and-ruler>Querier and Ruler</a></li><li><a href=#query-frontend>Query-frontend</a></li><li><a href=#compactor-and-store-gateway>Compactor and Store-gateway</a></li><li><a href=#ingester--blocks>Ingester – blocks</a></li></ul></li><li><a href=#step-2-ingesters-migration>Step 2: Ingesters migration</a><ul><li><a href=#known-issues>Known issues</a></li></ul></li><li><a href=#step-3-cleanup>Step 3: Cleanup</a><ul><li></li></ul></li><li><a href=#rollback>Rollback</a><ul><li><a href=#known-issues-1>Known issues</a></li></ul></li><li><a href=#appendix>Appendix</a><ul><li><a href=#jsonnet-config>Jsonnet config</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=/docs/>Documentation</a></li><li class=breadcrumb-item><a href=/docs/blocks-storage/>Blocks Storage</a></li><li class="breadcrumb-item active" aria-current=page><a href=/docs/blocks-storage/migrate-cortex-cluster-from-chunks-to-blocks/>Migrate Cortex cluster from chunks to blocks</a></li></ol></nav><div class=td-content><h1>Migrate Cortex cluster from chunks to blocks</h1><p>This article describes how to migrate existing Cortex cluster from chunks storage to blocks storage,
and highlight possible issues you may encounter in the process.</p><p><em>This document replaces the <a href=https://cortexmetrics.io/docs/proposals/ingesters-migration/>Cortex proposal</a>,
which was written before support for migration was in place.</em></p><h2 id=introduction>Introduction</h2><p>This article <strong>assumes</strong> that:</p><ul><li>Cortex cluster is managed by Kubernetes</li><li>Cortex is using chunks storage</li><li>Ingesters are using WAL</li><li>Cortex version 1.3.0 or later.</li></ul><p><em>If your ingesters are not using WAL, the documented procedure will still apply, but the presented migration script will not work properly without changes, as it assumes that ingesters are managed via StatefulSet.</em></p><p>The migration procedure is composed by 3 steps:</p><ol><li><a href=#step-1-preparation>Preparation</a></li><li><a href=#step-2-ingesters-migration>Ingesters migration</a></li><li><a href=#step-3-cleanup>Cleanup</a></li></ol><p><em>In case of any issue during or after the migration, this document also outlines a <a href=#rollback>Rollback</a> strategy.</em></p><h2 id=step-1-preparation>Step 1: Preparation</h2><p>Before starting the migration of ingesters, we need to prepare other services.</p><h3 id=querier-and-ruler>Querier and Ruler</h3><p><em>Everything discussed for querier applies to ruler as well, since it shares querier configuration – CLI flags prefix is <code>-querier</code> even when used by ruler.</em></p><p>Querier and ruler need to be reconfigured as follow:</p><ul><li><code>-querier.second-store-engine=blocks</code></li><li><code>-querier.query-store-after=0</code></li><li><code>-querier.ingester-streaming=false</code></li></ul><h4 id=-queriersecond-store-engineblocks><code>-querier.second-store-engine=blocks</code></h4><p>Querier (and ruler) needs to be reconfigured to query both chunks storage and blocks storage at the same time.
This is achieved by using <code>-querier.second-store-engine=blocks</code> option, and providing querier with full blocks configuration, but keeping &ldquo;primary&rdquo; store set to <code>-store.engine=chunks</code>.</p><h4 id=-querierquery-store-after0><code>-querier.query-store-after=0</code></h4><p>Querier (and ruler) has an option <code>-querier.query-store-after</code> to query store only if query hits data older than some period of time.
For example, if ingesters keep 12h of data in memory, there is no need to hit the store for queries that only need last 1h of data.
During the migration, this flag needs to be set to 0, to make queriers always consult the store when handling queries.
As chunks ingesters shut down, they flush chunks to the storage. They are then replaced with new ingesters configured
to use blocks. Queriers cannot fetch recent chunks from ingesters directly (as blocks ingester don&rsquo;t reload chunks),
and need to use storage instead.</p><h4 id=-querieringester-streamingfalse><code>-querier.ingester-streaming=false</code></h4><p>Querier (and ruler) in Cortex version 1.3.0 has a <a href=https://github.com/cortexproject/cortex/issues/2935>bug</a> and doesn&rsquo;t properly
merge streamed results from chunks and blocks-based ingesters. Instead it only returns data from blocks instesters.
To avoid this problem we can use newer Cortex release, or temporarily disable this feature by setting <code>-querier.ingester-streaming=false</code>.
After migration is complete (i.e. all ingesters are running blocks only), this can be turned back to true, which is the default value.</p><h3 id=query-frontend>Query-frontend</h3><p>Query-frontend needs to be reconfigured as follow:</p><ul><li><code>-querier.parallelise-shardable-queries=false</code></li></ul><h4 id=-querierparallelise-shardable-queriesfalse><code>-querier.parallelise-shardable-queries=false</code></h4><p>Query frontend has an option <code>-querier.parallelise-shardable-queries</code> to split some incoming queries into multiple queries based on sharding factor used in v11 schema of chunk storage.
As the description implies, it only works when using chunks storage.
During and after the migration to blocks (and also after possible rollback), this option needs to be disabled otherwise query-frontend will generate queries that cannot be satisfied by blocks storage.</p><h3 id=compactor-and-store-gateway>Compactor and Store-gateway</h3><p><a href=/docs/blocks-storage/compactor/>Compactor</a> and <a href=/docs/blocks-storage/store-gateway/>store-gateway</a> services should be deployed and successfully up and running before migrating ingesters.</p><h3 id=ingester--blocks>Ingester – blocks</h3><p>Migration script presented in Step 2 assumes that there are two StatefulSets of ingesters: existing one configured with chunks, and the new one with blocks.
New StatefulSet with blocks ingesters should have 0 replicas at the beginning of migration.</p><h2 id=step-2-ingesters-migration>Step 2: Ingesters migration</h2><p>We have developed a script available in Cortex <a href=https://github.com/cortexproject/cortex/blob/master/tools/migrate-ingester-statefulsets.sh><code>tools/migrate-ingester-statefulsets.sh</code></a> to migrate ingesters between two StatefulSets, shutting down ingesters one by one.</p><p>It can be used like this:</p><pre><code>$ tools/migrate-ingester-statefulsets.sh &lt;namespace&gt; &lt;ingester-old&gt; &lt;ingester-new&gt; &lt;num-instances&gt;
</code></pre><p>Where parameters are:</p><ul><li><code>&lt;namespace></code>: Kubernetes namespace where the Cortex cluster is running</li><li><code>&lt;ingester-old></code>: name of the ingesters StatefulSet to scale down (running chunks storage)</li><li><code>&lt;ingester-new></code>: name of the ingesters StatefulSet to scale up (running blocks storage)</li><li><code>&lt;num-instances></code>: number of instances to scale down (in <code>ingester-old</code> statefulset) and scale up (in <code>ingester-new</code>), or &ldquo;all&rdquo; – which will scale down all remaining instances in <code>ingester-old</code> statefulset</li></ul><p>After starting new pod in <code>ingester-new</code> statefulset, script then triggers <code>/shutdown</code> endpoint on the old ingester. When the flushing on the old ingester is complete, scale down of statefulset continues, and process repeats.</p><p><em>The script supports both migration from chunks to blocks, and viceversa (eg. rollback).</em></p><h3 id=known-issues>Known issues</h3><p>There are few known issues with the script:</p><ul><li>If expected messages don&rsquo;t appear in the log, but pod keeps on running, the script will never finish.</li><li>Script doesn&rsquo;t verify that flush finished without any error.</li></ul><h2 id=step-3-cleanup>Step 3: Cleanup</h2><p>When the ingesters migration finishes, there are still two StatefulSets, with original StatefulSet (running the chunks storage) having 0 instances now.</p><p>At this point, we can delete the old StatefulSet and its persistent volumes and recreate it with final blocks storage configuration (eg. changing PVs), and use the script again to move pods from <code>ingester-blocks</code> to <code>ingester</code>.</p><p>Querier (and ruler) can be reconfigured to use <code>blocks</code> as &ldquo;primary&rdquo; store to search, and <code>chunks</code> as secondary:</p><ul><li><code>-store.engine=blocks</code></li><li><code>-querier.second-store-engine=chunks</code></li><li><code>-querier.use-second-store-before-time=&lt;timestamp after ingesters migration has completed></code></li><li><code>-querier.ingester-streaming=true</code></li></ul><h4 id=-querieruse-second-store-before-time><code>-querier.use-second-store-before-time</code></h4><p>The CLI flag <code>-querier.use-second-store-before-time</code> (or its respective YAML config option) is only available for secondary store.
This flag can be set to a timestamp when migration has finished, and it avoids querying secondary store (chunks) for data when running queries that don&rsquo;t need data before given time.</p><h4 id=-querieringester-streamingtrue><code>-querier.ingester-streaming=true</code></h4><p>If querier was configured to disable ingester streaming during migration (required for Cortex 1.3.0), Querier can be configured to make use of streamed responses from ingester at this point (<code>-querier.ingester-streaming=true</code>).</p><h2 id=rollback>Rollback</h2><p>If rollback to chunks is needed for any reason, it is possible to use the same migration script with reversed arguments:</p><ul><li>Scale down ingesters StatefulSet running blocks storage</li><li>Scale up ingesters StatefulSet running chunks storage</li></ul><p><em>Blocks ingesters support the same <code>/shutdown</code> endpoint for flushing data.</em></p><p>During the rollback, queriers and rulers need to use the same configuration changes as during migration. You should also make sure the following settings are applied:</p><ul><li><code>-store.engine=chunks</code></li><li><code>-querier.second-store-engine=blocks</code></li><li><code>-querier.use-second-store-before-time</code> should not be set</li><li><code>-querier.ingester-streaming=false</code></li></ul><p>Once the rollback is complete, some configuration changes need to stay in place, because some data has already been stored to blocks:</p><ul><li>The query sharding in the query-frontend must be kept disabled, otherwise querying blocks will not work correctly</li><li><code>store-gateway</code> needs to keep running, otherwise querying blocks will fail</li><li><code>compactor</code> may be shutdown, after it has no more compaction work to do</li></ul><p>Kubernetes resources related to the ingesters running the blocks storage may be deleted.</p><h3 id=known-issues-1>Known issues</h3><p>After rollback, chunks ingesters will replay their old Write-Ahead-Log, thus loading old chunks into memory.
WAL doesn&rsquo;t remember whether these old chunks were already flushed or not, so they will be flushed again to the storage.
Until that flush happens, Cortex reports those chunks as unflushed, which may trigger some alerts based on <code>cortex_oldest_unflushed_chunk_timestamp_seconds</code> metric.</p><h2 id=appendix>Appendix</h2><h3 id=jsonnet-config>Jsonnet config</h3><p>This section shows how to use <a href=https://github.com/grafana/cortex-jsonnet>cortex-jsonnet</a> to configure additional services.</p><p>We will assume that <code>main.jsonnet</code> is main configuration for the cluster, that also imports <code>temp.jsonnet</code> – with our temporary configuration for migration.</p><p>In <code>main.jsonnet</code> we have something like this:</p><pre><code class=language-jsonnet data-lang=jsonnet>local cortex = import 'cortex/cortex.libsonnet';
local wal = import 'cortex/wal.libsonnet';
local temp = import 'temp.jsonnet';

// Note that 'tsdb' is not imported here.
cortex + wal + temp {
  _images+:: (import 'images.libsonnet'),

  _config+:: {
    cluster: 'k8s-cluster',
    namespace: 'k8s-namespace',

...
</code></pre><p>To configure querier to use secondary store for querying, we need to add:</p><pre><code>    querier_second_storage_engine: 'blocks',
    blocks_storage_bucket_name: 'bucket-for-storing-blocks',
</code></pre><p>to the <code>_config</code> object in main.jsonnet.</p><p>Let&rsquo;s generate blocks configuration now in <code>temp.jsonnet</code>.
There are comments inside that should give you an idea about what&rsquo;s happening.
Most important thing is generating resources with blocks configuration, and exposing some of them.</p><pre><code class=language-jsonnet data-lang=jsonnet>{
  local cortex = import 'cortex/cortex.libsonnet',
  local tsdb = import 'cortex/tsdb.libsonnet',
  local rootConfig = self._config,
  local statefulSet = $.apps.v1beta1.statefulSet,

  // Prepare TSDB resources, but hide them. Cherry-picked resources will be exposed later.
  tsdb_config:: cortex + tsdb + {
    _config+:: {
      cluster: rootConfig.cluster,
      namespace: rootConfig.namespace,
      external_url: rootConfig.external_url,

      // This Cortex cluster is using the blocks storage.
      storage_tsdb_bucket_name: rootConfig.storage_tsdb_bucket_name,
      cortex_store_gateway_data_disk_size: '100Gi',
      cortex_compactor_data_disk_class: 'fast',
    },

    // We create another statefulset for ingesters here, with different name.
    ingester_blocks_statefulset: self.newIngesterStatefulSet('ingester-blocks', self.ingester_container) +
                                 statefulSet.mixin.spec.withReplicas(0),

    ingester_blocks_pdb: self.newIngesterPdb('ingester-blocks-pdb', 'ingester-blocks'),
    ingester_blocks_service: $.util.serviceFor(self.ingester_blocks_statefulset, self.ingester_service_ignored_labels),
  },

  _config+: {
    queryFrontend+: {
      // Disabled because querying blocks-data breaks if query is rewritten for sharding.
      sharded_queries_enabled: false,
    },
  },

  // Expose some services from TSDB configuration, needed for running Querier with Chunks as primary and TSDB as secondary store.
  tsdb_store_gateway_pdb: self.tsdb_config.store_gateway_pdb,
  tsdb_store_gateway_service: self.tsdb_config.store_gateway_service,
  tsdb_store_gateway_statefulset: self.tsdb_config.store_gateway_statefulset,

  tsdb_memcached_metadata: self.tsdb_config.memcached_metadata,

  tsdb_ingester_statefulset: self.tsdb_config.ingester_blocks_statefulset,
  tsdb_ingester_pdb: self.tsdb_config.ingester_blocks_pdb,
  tsdb_ingester_service: self.tsdb_config.ingester_blocks_service,

  tsdb_compactor_statefulset: self.tsdb_config.compactor_statefulset,

  // Querier and ruler configuration used during migration, and after.
  query_config_during_migration:: {
    // Disable streaming, as it is broken when querying both chunks and blocks ingesters at the same time.
    'querier.ingester-streaming': 'false',

    // query-store-after is required during migration, since new ingesters running on blocks will not load any chunks from chunks-WAL.
    // All such chunks are however flushed to the store.
    'querier.query-store-after': '0',
  },

  query_config_after_migration:: {
    'querier.ingester-streaming': 'true',
    'querier.query-ingesters-within': '13h',  // TSDB ingesters have data for up to 4d.
    'querier.query-store-after': '12h',  // Can be enabled once blocks ingesters are running for 12h.

    // Switch TSDB and chunks. TSDB is &quot;primary&quot; now so that we can skip querying chunks for old queries.
    // We can do this, because querier/ruler have both configurations.
    'store.engine': 'blocks',
    'querier.second-store-engine': 'chunks',

    'querier.use-second-store-before-time': '2020-07-28T17:00:00Z',  // If migration from chunks finished around 18:10 CEST, no need to query chunk store for queries before this time.
  },

  querier_args+:: self.tsdb_config.blocks_metadata_caching_config + self.query_config_during_migration,  // + self.query_config_after_migration,
  ruler_args+:: self.tsdb_config.blocks_metadata_caching_config + self.query_config_during_migration,  // + self.query_config_after_migration,
}
</code></pre><div class="text-muted mt-5 pt-3 border-top"></div></div></main></div></div><footer class="row td-box td-box--dark td-box--gradient td-box--height-auto text-white p-5"><div class="col-12 col-sm-4 pb-5 pb-sm-0"><img src=/images/cortex-stacked-white.png width=75px class="img-fluid float-left"></div><div class="col-12 col-sm-4 pb-5 pb-sm-0"><h6 class=font-weight-bold>Community</h6><ul class=list-unstyled><li><a href=https://slack.cncf.io class="text-reset text-white"><i class="fab fa-fw fa-slack"></i>Slack</a></li><li><a href=https://github.com/cortexproject/cortex class="text-reset text-white"><i class="fab fa-fw fa-github"></i>GitHub</a></li><li><a href=https://twitter.com/cortexmetrics class="text-reset text-white"><i class="fab fa-fw fa-twitter"></i>Twitter</a></li></ul></div><div class="col-12 col-sm-4"><h6 class=font-weight-bold>About</h6><p>Cortex is an OSS licensed project as Apache License 2.0</p></div></footer></div><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js integrity=sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy crossorigin=anonymous></script><script src=/js/main.min.29b0315468c00226fa6f4556a9cebc0ac4fe1ce1457a01b22c0a06b329877383.js integrity="sha256-KbAxVGjAAib6b0VWqc68CsT+HOFFegGyLAoGsymHc4M=" crossorigin=anonymous></script></body></html>